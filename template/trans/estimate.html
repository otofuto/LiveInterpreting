<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="robots" content="noindex,nofollow">
		<title>Live interpreting</title>
		<link rel="stylesheet" href="/st/css/master.css">
		<link rel="stylesheet" href="/st/css/mark.css">
		<style>
			table {
				width: 90%;
			}

			tr {
				box-shadow: 0 1px 0 gray;
			}

			th {
				background-color: var(--color1);
				color: white;
			}

			td:nth-of-type(1) {
				width: fit-content;
				padding: 4px 10px;
				color: dimgray;
			}

			#sendEst {
				width: 100%;
				text-align: center;
			}
		</style>
	</head>
	<body>
		<script src="/st/js/header.js"></script>
		<main>
			<div id="sidemenu">
				<div onclick="location = '/home/'"><span>ホーム</span></div>
				<div onclick="location = '/inbox/'"><span>受信BOX</span></div>
				<div onclick="location = '/mypage/'"><span>マイページ</span></div>
				<div onclick="location = '/mypage/follows/'"><span>フォロー</span></div>
				<div onclick="location = '/mypage/lives/'"><span>配信登録</span></div>
				<div onclick="location = '/search/'"><span>翻訳者を探す</span></div>
				<div onclick="logout()"><span>ログアウト</span></div>
			</div>
			<div id="content">
				<h1>見積作成</h1>
				<table><tbody id="tbl"></tbody></table>
				<form name="fm" onsubmit="sub(); return false;" style="display: none;">
					<div class="field">
						<input type="number" class="input" name="price" required>
						<label class="input-label">見積金額</label>
					</div>
					<div class="field">
						<textarea name="response" class="textarea" required></textarea>
						<label class="input-label">見積詳細</label>
					</div>
					<div style="text-align: center;">
						<button class="button" style="background-color: var(--color1); color: white">見積を送信</button>
					</div>
				</form>
			</div>
		</main>
		<footer class="page-footer">
			<label>© 2021 Live interpreting - Powered by OTFT</label>
		</footer>
		<script src="/st/js/master.js"></script>
		<script>
			function appendRow(k, v) {
				let row = document.createElement('tr');
				let td1 = document.createElement('td');
				td1.innerText = k;
				row.appendChild(td1);
				let td2 = document.createElement('td');
				td2.innerText = v;
				row.appendChild(td2);
				document.getElementById('tbl').appendChild(row);
				return row;
			}
			function appendHeader(text) {
				let row = document.createElement('tr');
				let th = document.createElement('th');
				th.innerText = text;
				th.setAttribute('colspan', '2');
				row.appendChild(th);
				document.getElementById('tbl').appendChild(row);
			}
			function frontZero(s) {
				if ((s - 0) < 10) s = '0' + s;
				return s;
			}
			let msg = JSON.parse("{{ .Message }}");
			document.title = msg.trans.request_title + ' | Live interpreting';
			appendHeader('依頼内容');
			appendRow('依頼タイトル', msg.trans.request_title);
			appendRow('依頼詳細', msg.trans.request);
			appendRow('予算範囲', msg.trans.budget_range);
			let livestart = new Date(msg.trans.live_start.String);
			appendRow('配信日時', livestart.getFullYear() + '年 ' +
					(livestart.getMonth() + 1) + '月 ' + livestart.getDate() + '日 ' +
					frontZero(livestart.getHours()) + ':' + frontZero(livestart.getMinutes()) +
					" ～ " + msg.trans.live_time.Int64 + '分程度');
			appendRow('通訳言語', msg.trans.lang);
			appendRow('通訳形態', ['テキスト', '音声', 'テキストと音声'][msg.trans.request_type]);
			let limitTr = appendRow('提案期限', msg.trans.estimate_limit_date.String);
			if (msg.trans.request_cancel == 0 && !msg.trans.response_type.Valid) {
				let limit = new Date(msg.trans.estimate_limit_date.String);
				if (!msg.trans.estimate_limit_date.Valid) {
					limit = new Date(msg.trans.live_start);
				}
				let nextdate = new Date(limit);
				nextdate.setHours(0);
				nextdate.setMinutes(0);
				nextdate.setSeconds(0);
				nextdate.setMilliseconds(0);
				nextdate.setDate(nextdate.getDate() + 1);
				console.log(nextdate);
				if (new Date() < nextdate) {
					document.fm.removeAttribute('style');
				} else {
					document.fm.remove();
					limitTr.getElementsByTagName('td')[1].innerHTML += " <span style=\"color: red;\">期限切れ</span>";
				}
			}

			function sub() {
				let data = new FormData(document.fm);
				formDisabled(document.fm, true);
				post('/trans/estimate/' + msg.trans.id, data)
				.then(res => {
					if (res === true) {
						alert('登録成功');
						location = '/u/{{ .User.Id }}';
					} else if (typeof res.id == 'number') {
						alert('登録成功');
						location = '/trans/' + res.id;
					} else {
						formDisabled(document.fm, false);
						console.error(res);
						alert("登録に失敗しました。");
					}
				}).catch(err => {
					formDisabled(document.fm, false);
					console.error(err);
					alert('登録に失敗しました。');
				});
			}
		</script>
	</body>
</html>