<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="robots" content="noindex,nofollow">
		<title>ダイレクトメッセージ - {{ .Account.Name }}さん | Live interpreting</title>
		<link rel="stylesheet" href="/st/css/master.css">
		<style>
			#accountinfo {
				display: block;
				position: fixed;
				left: 76%;
				top: calc(var(--header-height) + 20px);
				width: calc(23% - 20px);
				padding: 10px;
				border-radius: 10px;
				box-shadow: 0 0 10px gray;
			}

			#content {
				width: 50%;
				min-height: 150px;
				margin: 0 auto;
				border: solid 1px gray;
				text-align: center;
				font-family: 'M PLUS Rounded 1c', sans-serif;
			}

			#inputMessage {
				display: block;
				width: 50%;
				margin: 0 auto;
				border: solid 1px gray;
			}

			@media screen and (max-width: 812px) {
				#accountinfo {
					width: calc(96% - 20px);
					left: 2%;
					top: 0;
					position: relative;
					margin-bottom: 20px;
				}

				#content {
					width: 100%;
				}

				#inputMessage {
					width: 100%;
				}
			}

			.msg {
				border-bottom: solid 1px black;
				text-align: left;
			}

			.icon-disp {
				position: relative;
				display: inline-block;
				width: 75px;
				height: 75px;
				margin-right: 20px;
				vertical-align: top;
				border-radius: 5px;
				background-size: cover;
				background-position: center;
				background-color: lightgray;
			}

			#textarea {
				display: block;
				width: 90%;
				height: 150px;
				margin: 30px auto;
			}
		</style>
	</head>
	<body>
		<header class="page-header">
			<div class="service-title">Live interpreting</div>
		</header>
		<main>
			<div id="accountinfo">
				<div class="icon-disp" style="background-image: url('/Account/img/{{ .Account.Id }}');" onclick="location = '/u/{{ .Account.Id }}';"></div>
				<p style="font-weight: bold;">{{ .Account.Name }}</p>
				<pre>{{ .Account.Description }}</pre>
			</div>
			<div id="content">
				{{ range .DM }}
				<div class="msg">
					<div>
						<div class="icon-disp" style="background-image: url('/Account/img/{{ .From }}');" onclick="location = '/u/{{ .From }}';"></div>
						<div style="display: inline-block;">
							<p>{{ if eq .From $.Account.Id }}{{ $.Account.Name }}{{ else }}{{ $.Login.Name }}{{ end }}</p>
							<p style="color: gray;">{{ .CreatedAt }}</p>
						</div>
					</div>
					<pre>{{ .Message }}</pre>
				</div>
				{{ end }}
			</div>
			<div id="inputMessage">
				<form name="fm" onsubmit="return false;">
					<textarea name="message" id="textarea"></textarea>
					<button class="button" style="display: block; margin: 0 auto; width: 300px; margin-bottom: 30px;" onclick="send()">ダイレクトメッセージを送信</button>
				</form>
			</div>
		</main>
		<footer class="page-footer">
			<label>© 2020 Live interpreting - Powered by OTFT</label>
		</footer>
		<script src="/st/js/master.js"></script>
		<script>
			function send() {
				var data = new FormData(document.fm);
				fetch('/directmessages/{{ .Account.Id }}', {
					method: "post",
					body: data,
					credentials: "include"
				}).then(res => {
					if (res.status == 200)
						return res.json();
					else
						return null;
				}).then(result => {
					if (result == null) {
						alert('送信に失敗しました。');
					} else {
						document.fm.message.value = "";
					}
				}).catch(err => {
					console.error(err);
					alert('送信に失敗しました。');
				});
			}

			function connectWs() {
				var chatId = "dm{{ if gt .Login.Id .Account.Id }}{{ .Account.Id }}_{{ .Login.Id }}{{ else }}{{ .Login.Id }}_{{ .Account.Id }}{{ end }}";
				ws = new WebSocket((window.location.host == "live-interpreting.herokuapp.com" ? "wss://" : "ws://") + window.location.host + "/ws/" + chatId);
				//ws = new WebSocket("wss://" + window.location.host + "/ws/" + chatId);

				ws.onopen = () => {
					console.log("ws connected.");
				}

				ws.onmessage = message => {
					var data = JSON.parse(message.data);
					var msg = document.createElement("div");
					msg.setAttribute("class", "msg");
					document.getElementById("content").appendChild(msg);

					var div = document.createElement("div");
					msg.appendChild(div);

					var iconDisp = document.createElement("div");
					iconDisp.setAttribute("class", "icon-disp");
					iconDisp.style.backgroundImage = "url('/Account/img/" + data.from + "')";
					iconDisp.setAttribute("onclick", "location = '/u/" + data.from + "';");
					div.appendChild(iconDisp);

					var inline = document.createElement("div");
					inline.style.display = "inline-block";
					div.appendChild(inline);

					var p1 = document.createElement("p");
					p1.innerText = data.from == {{ .Login.Id }} ? "{{ .Login.Name }}" : "{{ .Account.Name }}";
					inline.appendChild(p1);

					var p2 = document.createElement("p");
					p2.style.color = "gray";
					p2.innerText = data.created_at;
					inline.appendChild(p2);

					var pre = document.createElement("pre");
					pre.innerText = data.message;
					msg.appendChild(pre);

					msg.scrollIntoView(true);
				}

				ws.onclose = () => {
					connectWs();
				}
			}

			function sendMessage(str) {
				var msg = {
					"message": str
				};
				ws.send(JSON.stringify(msg));
			}

			connectWs();
		</script>
	</body>
</html>